-- A. CATÁLOGOS SIMPLES -----------------------

-- 1. Catálogo de Estados
CREATE TABLE CatEstado (
    id_estado     NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nombre_estado VARCHAR2(50) NOT NULL UNIQUE,
    descripcion   VARCHAR2(200)
);

-- 2. Catálogo de Ciudades
CREATE TABLE CatCiudad (
    id_ciudad     NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nombre_ciudad VARCHAR2(100) NOT NULL UNIQUE
);

-- 3. Catálogo de Géneros
CREATE TABLE CatGenero (
    id_genero     NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nombre_genero VARCHAR2(100) NOT NULL UNIQUE
);


-- B. TABLAS PRINCIPALES 

-- 4. Ubicación
CREATE TABLE Ubicacion (
    id_ubicacion NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    id_ciudad    NUMBER NOT NULL, -- FK
    direccion    VARCHAR2(200) NOT NULL,
    CONSTRAINT fk_ubicacion_ciudad FOREIGN KEY (id_ciudad) 
        REFERENCES CatCiudad(id_ciudad)
);

-- 5. Cliente
CREATE TABLE Cliente (
    id_cliente         NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    correo_electronico VARCHAR2(150) NOT NULL UNIQUE,
    nombre_completo    VARCHAR2(200) NOT NULL,
    id_ubicacion       NUMBER NOT NULL,
    CONSTRAINT fk_cliente_ubicacion FOREIGN KEY (id_ubicacion) 
        REFERENCES Ubicacion(id_ubicacion)
);

-- 6. Libro
CREATE TABLE Libro (
    id_libro  NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    id_genero NUMBER NOT NULL, -- FK
    autor     VARCHAR2(100),
    titulo    VARCHAR2(100),
    CONSTRAINT fk_libro_genero FOREIGN KEY (id_genero) 
        REFERENCES CatGenero(id_genero)
);

-- 7. Histórico de Precios
CREATE TABLE HistoricoPrecio (
    id_historico_precio NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    id_libro            NUMBER NOT NULL,
    precio              NUMBER(12,2) NOT NULL CHECK (precio > 0),
    fecha_inicio        DATE NOT NULL,
    fecha_fin           DATE,
    vigente             CHAR(1) DEFAULT '1' CHECK (vigente IN ('0','1')),
    CONSTRAINT fk_hist_precio_libro FOREIGN KEY (id_libro) 
        REFERENCES Libro(id_libro),
    CONSTRAINT chk_fechas_precio CHECK (fecha_fin IS NULL OR fecha_fin > fecha_inicio)
);

-- 8. Pedido
CREATE TABLE Pedido (
    id_pedido        NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    id_cliente       NUMBER NOT NULL,
    fecha            DATE DEFAULT SYSDATE NOT NULL,
    id_estado_actual NUMBER NOT NULL,
    fecha_ult_cambio DATE DEFAULT SYSDATE NOT NULL,
    CONSTRAINT fk_pedido_cliente FOREIGN KEY (id_cliente) 
        REFERENCES Cliente(id_cliente),
    CONSTRAINT fk_pedido_estado FOREIGN KEY (id_estado_actual)
        REFERENCES CatEstado(id_estado)
);

-- 9. Histórico de Estados
CREATE TABLE HistoricoEstadoPedido (
    id_historico_estado NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    id_pedido           NUMBER NOT NULL,
    id_estado           NUMBER NOT NULL,
    fecha_cambio        DATE DEFAULT SYSDATE NOT NULL,
    observaciones       VARCHAR2(500),
    CONSTRAINT fk_hep_pedido FOREIGN KEY (id_pedido) 
        REFERENCES Pedido(id_pedido),
    CONSTRAINT fk_hep_estado FOREIGN KEY (id_estado) 
        REFERENCES CatEstado(id_estado)
);

-- 10. Detalle de Pedido
CREATE TABLE DetallePedido (
    id_detalle      NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    id_pedido       NUMBER NOT NULL,
    id_libro        NUMBER NOT NULL,
    cantidad        NUMBER(6) NOT NULL CHECK (cantidad > 0),
    precio_unitario NUMBER(12,2) NOT NULL CHECK (precio_unitario > 0),
    CONSTRAINT fk_detalle_pedido FOREIGN KEY (id_pedido) 
        REFERENCES Pedido(id_pedido) ON DELETE CASCADE,
    CONSTRAINT fk_detalle_libro FOREIGN KEY (id_libro) 
        REFERENCES Libro(id_libro),
    CONSTRAINT uq_pedido_libro UNIQUE (id_pedido, id_libro)
);
